# Използване на инструменти за ШИМ

Този документ описва как да настроите лазер или шпиндел с ШИМ управление, като използвате `output_pin` и някои макроси.

## Как работи?

С повторното използване на изхода pwm на вентилатора на печатащата глава можете да управлявате лазери или шпиндели. Това е полезно, ако използвате превключваеми печатащи глави, например E3D toolchanger или решение "Направи си сам". Обикновено cam-инструментите, като LaserWeb, могат да бъдат конфигурирани да използват команди `M3-M5`, които означават *скорост на шпиндела CW* (`M3 S[0-255]`), *скорост на шпиндела CCW* (`M4 S[0-255]`) и *спиране на шпиндела* (`M5`).

**Предупреждение:** Когато управлявате лазер, спазвайте всички мерки за сигурност, за които можете да се сетите! Диодните лазери обикновено са инвертирани. Това означава, че когато MCU се рестартира, лазерът ще бъде *изцяло на* за времето, необходимо на MCU да се стартира отново. За добра мярка се препоръчва винаги ** да носите подходящи лазерни очила с подходяща дължина на вълната, ако лазерът е захранен; и да изключвате лазера, когато не е необходим. Също така трябва да конфигурирате безопасно време за прекъсване, така че когато вашият хост или MCU се сблъска с грешка, инструментът да спре.

За примерна конфигурация вижте [config/sample-pwm-tool.cfg](/config/sample-pwm-tool.cfg).

## Текущи ограничения

Съществува ограничение за това колко често могат да се извършват актуализации на ШИМ. Въпреки че е много прецизна, PWM актуализация може да се извършва само на всеки 0,1 секунди, което я прави почти безполезна за растерно гравиране. Съществува обаче [експериментален клон](https://github.com/Cirromulus/klipper/tree/laser_tool) със собствени компромиси. В дългосрочен план се планира добавяне на тази функционалност в клипъра от основната линия.

## Команди

`M3/M4 S<стойност>`: Задайте работния цикъл на ШИМ. Стойности между 0 и 255. `M5`: Спиране на ШИМ изхода до стойност за изключване.

## Конфигурация на Laserweb

Ако използвате Laserweb, една работеща конфигурация би била:

    GCODE START:
        M5            ; Disable Laser
        G21           ; Set units to mm
        G90           ; Absolute positioning
        G0 Z0 F7000   ; Set Non-Cutting speed
    
    GCODE END:
        M5            ; Disable Laser
        G91           ; relative
        G0 Z+20 F4000 ;
        G90           ; absolute
    
    GCODE HOMING:
        M5            ; Disable Laser
        G28           ; Home all axis
    
    TOOL ON:
        M3 $INTENSITY
    
    TOOL OFF:
        M5            ; Disable Laser
    
    LASER INTENSITY:
        S
