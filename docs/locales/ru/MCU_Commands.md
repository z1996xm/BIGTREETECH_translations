# MCU команды

В этом документе содержится информация о низкоуровневых командах микроконтроллера, которые отправляются из «хост-программы» Klipper и обрабатываются программным обеспечением микроконтроллера Klipper. Этот документ не является авторитетным справочником по этим командам и не является эксклюзивным списком всех доступных команд.

Этот документ может быть полезен разработчикам, заинтересованным в понимании низкоуровневых команд микроконтроллера.

См. документ [protocol](Protocol.md) для получения дополнительной информации о формате команд и их передаче. Команды здесь описываются с использованием их синтаксиса в стиле «printf» — для тех, кто не знаком с этим форматом, просто обратите внимание, что там, где встречается последовательность '%...', ее следует заменить фактическим целым числом. Например, описание «count=%c» можно заменить текстом «count=10». Обратите внимание, что параметры, которые считаются «перечислениями» (см. приведенный выше протокольный документ), принимают строковое значение, которое автоматически преобразуется в целочисленное значение для микроконтроллера. Это характерно для параметров с именем «pin» (или с суффиксом «_pin»).

## Команды запуска

Может потребоваться выполнение определенных разовых действий по настройке микроконтроллера и его периферийных устройств. В этом разделе перечислены общие команды, доступные для этой цели. В отличие от большинства команд микроконтроллера, эти команды выполняются, как только они получены, и они не требуют какой-либо специальной настройки.

Общие команды запуска:

* `set_digital_out pin=%u value=%c` : эта команда немедленно настраивает данный контакт как цифровой выход GPIO и устанавливает для него либо низкий уровень (значение = 0), либо высокий уровень (значение = 1). Эта команда может быть полезна для настройки начального значения светодиодов LED и для настройки начального значения микрошаговых контактов драйвера шагового двигателя.
* `set_pwm_out pin=%u cycle_ticks=%u value=%hu` : Эта команда немедленно настроит данный вывод для использования аппаратной широтно-импульсной модуляции (ШИМ) с заданным количеством cycle_ticks. «cycle_ticks» — это количество тиков часов MCU, которое должен длиться каждый цикл включения и выключения питания. Значение cycle_ticks, равное 1, может использоваться для запроса максимально возможного времени цикла. Параметр «значение» находится в диапазоне от 0 до 255, где 0 указывает на полное выключение, а 255 указывает на полное включение. Эта команда может быть полезна для включения вентиляторов охлаждения ЦП и сопла.

## Низкоуровневая конфигурация микроконтроллера

Большинство команд в микроконтроллере требуют первоначальной настройки, прежде чем их можно будет успешно вызывать. В этом разделе представлен обзор процесса настройки. Этот раздел и следующие разделы, вероятно, будут интересны только разработчикам, интересующимся внутренними деталями Klipper.

Когда хост впервые подключается к микроконтроллеру, он всегда начинает с получения словаря данных (см. [protocol](Protocol.md) для получения дополнительной информации). После получения словаря данных хост проверит, находится ли микроконтроллер в «настроенном» состоянии, и настроит его, если нет. Конфигурация включает в себя следующие этапы:

* `get_config` : Хост начинает с проверки, настроен ли уже микроконтроллер. Микроконтроллер отвечает на эту команду ответным сообщением «config». Программное обеспечение микроконтроллера всегда запускается в ненастроенном состоянии при включении питания. Он остается в этом состоянии до тех пор, пока хост не завершит процессы настройки (выполнив команду finalize_config). Если микроконтроллер уже сконфигурирован из предыдущего сеанса (и сконфигурирован с нужными параметрами), то от хоста не требуется никаких дальнейших действий, и процесс конфигурирования завершается успешно.
* `allocate_oids count=%c`: эта команда выдается для информирования микроконтроллера о максимальном количестве идентификаторов объектов (oid), которое требуется хосту. Данную команду допустимо выполнить только один раз. oid — это целочисленный идентификатор, назначенный каждому степперу, каждому концевому упору и каждому планируемому выводу gpio. Хост заранее определяет количество oid, которое потребуется для работы оборудования, и передает его микроконтроллеру, чтобы он мог выделить достаточно памяти для хранения отображения от oid к внутреннему объекту.
* `config_XXX oid=%c ...` : По соглашению любая команда, начинающаяся с префикса «config_», создает новый объект микроконтроллера и назначает ему данный oid. Например, команда config_digital_out настроит указанный вывод как цифровой вывод GPIO и создаст внутренний объект, который хост может использовать для планирования изменений в данном GPIO. Параметр oid, передаваемый в команду config, выбирается хостом и должен быть между нулем и максимальным значением, указанным в команде allocate_oids. Команды config могут выполняться только тогда, когда микроконтроллер не находится в сконфигурированном состоянии (т. е. до отправки хостом finalize_config) и после отправки команды allocate_oids.
* `finalize_config crc=%u` : The finalize_config command transitions the micro-controller from an unconfigured state to a configured state. The crc parameter passed to the micro-controller is stored and provided back to the host in "config" response messages. By convention, the host takes a 32bit CRC of the configuration it will request and at the start of subsequent communication sessions it checks that the CRC stored in the micro-controller exactly matches its desired CRC. If the CRC does not match then the host knows the micro-controller has not been configured in the state desired by the host.

### Общие объекты микроконтроллера

В этом разделе перечислены некоторые часто используемые команды конфигурации.

* `config_digital_out oid=%c pin=%u value=%c default_value=%c max_duration=%u` : This command creates an internal micro-controller object for the given GPIO 'pin'. The pin will be configured in digital output mode and set to an initial value as specified by 'value' (0 for low, 1 for high). Creating a digital_out object allows the host to schedule GPIO updates for the given pin at specified times (see the queue_digital_out command described below). Should the micro-controller software go into shutdown mode then all configured digital_out objects will be set to 'default_value'. The 'max_duration' parameter is used to implement a safety check - if it is non-zero then it is the maximum number of clock ticks that the host may set the given GPIO to a non-default value without further updates. For example, if the default_value is zero and the max_duration is 16000 then if the host sets the gpio to a value of one then it must schedule another update to the gpio pin (to either zero or one) within 16000 clock ticks. This safety feature can be used with heater pins to ensure the host does not enable the heater and then go off-line.
* `config_pwm_out oid=%c pin=%u cycle_ticks=%u value=%hu default_value=%hu max_duration=%u` : This command creates an internal object for hardware based PWM pins that the host may schedule updates for. Its usage is analogous to config_digital_out - see the description of the 'set_pwm_out' and 'config_digital_out' commands for parameter description.
* `config_analog_in oid=%c pin=%u` : This command is used to configure a pin in analog input sampling mode. Once configured, the pin can be sampled at regular interval using the query_analog_in command (see below).
* `config_stepper oid=%c step_pin=%c dir_pin=%c invert_step=%c step_pulse_ticks=%u` : This command creates an internal stepper object. The 'step_pin' and 'dir_pin' parameters specify the step and direction pins respectively; this command will configure them in digital output mode. The 'invert_step' parameter specifies whether a step occurs on a rising edge (invert_step=0) or falling edge (invert_step=1). The 'step_pulse_ticks' parameter specifies the minimum duration of the step pulse. If the mcu exports the constant 'STEPPER_BOTH_EDGE=1' then setting step_pulse_ticks=0 and invert_step=-1 will setup for stepping on both the rising and falling edges of the step pin.
* `config_endstop oid=%c pin=%c pull_up=%c stepper_count=%c` : This command creates an internal "endstop" object. It is used to specify the endstop pins and to enable "homing" operations (see the endstop_home command below). The command will configure the specified pin in digital input mode. The 'pull_up' parameter determines whether hardware provided pullup resistors for the pin (if available) will be enabled. The 'stepper_count' parameter specifies the maximum number of steppers that this endstop may need to halt during a homing operation (see endstop_home below).
* `config_spi oid=%c bus=%u pin=%u mode=%u rate=%u shutdown_msg=%*s` : This command creates an internal SPI object. It is used with spi_transfer and spi_send commands (see below). The "bus" identifies the SPI bus to use (if the micro-controller has more than one SPI bus available). The "pin" specifies the chip select (CS) pin for the device. The "mode" is the SPI mode (should be between 0 and 3). The "rate" parameter specifies the SPI bus rate (in cycles per second). Finally, the "shutdown_msg" is an SPI command to send to the given device should the micro-controller go into a shutdown state.
* `config_spi_without_cs oid=%c bus=%u mode=%u rate=%u shutdown_msg=%*s` : This command is similar to config_spi, but without a CS pin definition. It is useful for SPI devices that do not have a chip select line.

## Common commands

This section lists some commonly used run-time commands. It is likely only of interest to developers looking to gain insight into Klipper.

* `set_digital_out_pwm_cycle oid=%c cycle_ticks=%u` : This command configures a digital output pin (as created by config_digital_out) to use "software PWM". The 'cycle_ticks' is the number of clock ticks for the PWM cycle. Because the output switching is implemented in the micro-controller software, it is recommended that 'cycle_ticks' correspond to a time of 10ms or greater.
* `queue_digital_out oid=%c clock=%u on_ticks=%u` : This command will schedule a change to a digital output GPIO pin at the given clock time. To use this command a 'config_digital_out' command with the same 'oid' parameter must have been issued during micro-controller configuration. If 'set_digital_out_pwm_cycle' has been called then 'on_ticks' is the on duration (in clock ticks) for the pwm cycle. Otherwise, 'on_ticks' should be either 0 (for low voltage) or 1 (for high voltage).
* `queue_pwm_out oid=%c clock=%u value=%hu` : Schedules a change to a hardware PWM output pin. See the 'queue_digital_out' and 'config_pwm_out' commands for more info.
* `query_analog_in oid=%c clock=%u sample_ticks=%u sample_count=%c rest_ticks=%u min_value=%hu max_value=%hu` : This command sets up a recurring schedule of analog input samples. To use this command a 'config_analog_in' command with the same 'oid' parameter must have been issued during micro-controller configuration. The samples will start as of 'clock' time, it will report on the obtained value every 'rest_ticks' clock ticks, it will over-sample 'sample_count' number of times, and it will pause 'sample_ticks' number of clock ticks between over-sample samples. The 'min_value' and 'max_value' parameters implement a safety feature - the micro-controller software will verify the sampled value (after any oversampling) is always between the supplied range. This is intended for use with pins attached to thermistors controlling heaters - it can be used to check that a heater is within a temperature range.
* `get_clock`: эта команда заставляет микроконтроллер генерировать ответное сообщение «часы». Хост посылает эту команду один раз в секунду, чтобы получить значение часов микроконтроллера и оценить дрейф между часами хоста и микроконтроллера. Это позволяет хосту точно оценить тактовую частоту микроконтроллера.

### Шаговые команды

* `queue_step oid=%c interval=%u count=%hu add=%hi` : This command schedules 'count' number of steps for the given stepper, with 'interval' number of clock ticks between each step. The first step will be 'interval' number of clock ticks since the last scheduled step for the given stepper. If 'add' is non-zero then the interval will be adjusted by 'add' amount after each step. This command appends the given interval/count/add sequence to a per-stepper queue. There may be hundreds of these sequences queued during normal operation. New sequence are appended to the end of the queue and as each sequence completes its 'count' number of steps it is popped from the front of the queue. This system allows the micro-controller to queue potentially hundreds of thousands of steps - all with reliable and predictable schedule times.
* `set_next_step_dir oid=%c dir=%c` : эта команда указывает значение dir_pin, которое будет использовать следующая команда queue_step.
* `reset_step_clock oid=%c clock=%u` : Как правило, синхронизация шага соответствует последнему шагу для данного шага. Эта команда сбрасывает тактовый сигнал так, чтобы следующий шаг был связан с предоставленным временем тактового сигнала. Обычно хост отправляет эту команду только в начале печати.
* `stepper_get_position oid=%c` : This command causes the micro-controller to generate a "stepper_position" response message with the stepper's current position. The position is the total number of steps generated with dir=1 minus the total number of steps generated with dir=0.
* `endstop_home oid=%c clock=%u sample_ticks=%u sample_count=%c rest_ticks=%u pin_value=%c` : This command is used during stepper "homing" operations. To use this command a 'config_endstop' command with the same 'oid' parameter must have been issued during micro-controller configuration. When this command is invoked, the micro-controller will sample the endstop pin every 'rest_ticks' clock ticks and check if it has a value equal to 'pin_value'. If the value matches (and it continues to match for 'sample_count' additional samples spread 'sample_ticks' apart) then the movement queue for the associated stepper will be cleared and the stepper will come to an immediate halt. The host uses this command to implement homing - the host instructs the endstop to sample for the endstop trigger and then it issues a series of queue_step commands to move a stepper towards the endstop. Once the stepper hits the endstop, the trigger will be detected, the movement halted, and the host notified.

### Очередь перемещения

Каждая команда queue_step использует запись в «очереди перемещения» микроконтроллера. Эта очередь выделяется при получении команды «finalize_config» и сообщает о количестве доступных записей в очереди в ответных сообщениях «config».

Хост несет ответственность за обеспечение наличия свободного места в очереди перед отправкой команды queue_step. Хост делает это, вычисляя время завершения каждой команды queue_step и соответствующим образом планируя новые команды queue_step.

### SPI Commands

* `spi_transfer oid=%c data=%*s` : This command causes the micro-controller to send 'data' to the spi device specified by 'oid' and it generates a "spi_transfer_response" response message with the data returned during the transmission.
* `spi_send oid=%c data=%*s` : This command is similar to "spi_transfer", but it does not generate a "spi_transfer_response" message.
