# Фаза Endstop

В этом документе описывается система концевого упора Klipper с регулировкой ступенчатой фазы. Эта функциональность может повысить точность традиционных конечных выключателей. Это наиболее полезно при использовании драйвера шагового двигателя Trinamic, который имеет конфигурацию во время выполнения.

Типичный концевой выключатель имеет точность около 100 микрон. (Каждый раз, когда ось устанавливается на место, переключатель может срабатывать немного раньше или немного позже.) Хотя это относительно небольшая ошибка, она может привести к нежелательным артефактам. В частности, это позиционное отклонение может быть заметно при печати первого слоя объекта. В отличие от этого, обычные шаговые двигатели могут обеспечить значительно более высокую точность.

Механизм концевого выключателя с регулируемой фазой шага может использовать точность шаговых двигателей для повышения точности концевых выключателей. Шаговый двигатель движется циклически через ряд фаз, пока не завершит четыре "полных шага". Таким образом, шаговый двигатель, использующий 16 микрошагов, будет иметь 64 фазы, и при движении в положительном направлении он будет циклически проходить через фазы: 0, 1, 2, ... 61, 62, 63, 0, 1, 2, и т.д. Важно отметить, что когда шаговый двигатель находится в определенном положении на линейном рельсе, он всегда должен находиться в одной и той же фазе шага. Таким образом, когда каретка приводит в действие концевой выключатель, шаговый двигатель, управляющий этой кареткой, всегда должен находиться в одной и той же фазе шагового двигателя. Система endstop phase от Klipper сочетает в себе шаговую фазу с триггером endstop для повышения точности endstop.

Для того, чтобы использовать эту функциональность, необходимо иметь возможность идентифицировать фазу шагового двигателя. Если кто-то использует драйверы Trinamic TMC2130, TMC2208, TMC2224 или TMC2660 в режиме конфигурации во время выполнения (т.Е. не в автономном режиме), то Klipper может запросить шаговую фазу у драйвера. (Также возможно использовать эту систему на традиционных шаговых драйверах, если можно надежно сбросить шаговые драйверы - подробности см. Ниже.)

## Калибровка фаз конечного останова

При использовании драйверов шаговых двигателей Trinamic с конфигурацией во время выполнения можно откалибровать фазы конечного останова с помощью команды ENDSTOP_PHASE_CALIBRATE. Начните с добавления в файл конфигурации следующих параметров:

```
[endstop_phase]
```

Затем перезагрузите принтер и выполните команду `G28`, а затем команду `ENDSTOP_PHASE_CALIBRATE`. Затем переместите головку инструмента в другое место и снова выполните команду `G28`. Попробуйте переместить головку инструмента в несколько разных мест и повторно запустить `G28` из каждого положения. Выполните не менее пяти команд `G28`.

После выполнения вышеуказанных действий команда `ENDSTOP_PHASE_CALIBRATE` часто сообщает о той же (или почти той же) фазе для степпера. Эту фазу можно сохранить в конфигурационном файле, чтобы все последующие команды G28 использовали эту фазу. (Таким образом, при последующих операциях самонаведения клипер будет занимать одно и то же положение, даже если конечная остановка сработает немного раньше или немного позже.)

Чтобы сохранить фазу остановки для конкретного шагового двигателя, выполните примерно следующее:

```
ENDSTOP_PHASE_CALIBRATE STEPPER=stepper_z
```

Выполните описанные выше действия для всех степперов, которые вы хотите сохранить. Обычно это используется для степпера_z для картезианских и корексиальных принтеров и для степпера_a, степпера_b и степпера_c для дельта-принтеров. Наконец, выполните следующую команду, чтобы обновить конфигурационный файл с данными:

```
SAVE_CONFIG
```

### Дополнительные примечания

* Эта функция наиболее полезна на дельта-принтерах и на концевых упорах Z на картезианских/корексиальных принтерах. Можно использовать эту функцию на концевых упорах XY картриджного принтера, но это не особенно полезно, поскольку незначительная ошибка в положении концевого упора X/Y вряд ли повлияет на качество печати. Недопустимо использовать эту функцию для концевых упоров XY принтеров с корексией (так как положение XY не определяется одним шагом при корексиальной кинематике). Недопустимо использовать эту функцию на принтере, использующем концевой упор Z "probe:z_virtual_endstop" (так как фаза шага стабильна, только если концевой упор находится в статичном положении на рельсе).
* После калибровки фазы концевого упора, если впоследствии концевой упор будет перемещен или отрегулирован, необходимо будет повторно откалибровать концевой упор. Удалите данные калибровки из файла конфигурации и повторно выполните описанные выше действия.
* Для использования этой системы концевой упор должен быть достаточно точным, чтобы определить положение шагового механизма в пределах двух "полных шагов". Так, например, если шаговик использует 16 микрошагов с шаговым расстоянием 0,005 мм, то концевой упор должен иметь точность не менее 0,160 мм. Если появляются сообщения об ошибке типа "Endstop stepper_z incorrect phase", это может быть связано с недостаточно точным концевым упором. Если повторная калибровка не помогает, отключите регулировку фазы концевого ограничителя, удалив ее из файла конфигурации.
* Если используется традиционная ось Z с шаговым управлением (как на картезианском или корекси принтере) вместе с традиционными винтами для выравнивания ложа, то можно также использовать эту систему для организации выполнения каждого слоя печати на границе "полного шага". Чтобы включить эту функцию, убедитесь, что слайсер G-Code настроен на высоту слоя, кратную "полному шагу", вручную включите опцию endstop_align_zero в разделе конфигурации endstop_phase (подробности см. в [config reference](Config_Reference.md#endstop_phase)), а затем снова выровняйте винты станины.
* Можно использовать эту систему с традиционными (нетринамическими) драйверами шаговых двигателей. Однако для этого необходимо убедиться, что драйверы шаговых двигателей сбрасываются каждый раз, когда сбрасывается микроконтроллер. (Если эти два устройства всегда сбрасываются вместе, то Klipper может определить фазу шагового двигателя, отслеживая общее количество шагов, на которое он дал команду шаговому двигателю). В настоящее время единственный способ сделать это надежно - если и микроконтроллер, и драйверы шаговых двигателей питаются исключительно от USB, а питание USB обеспечивается от хоста, работающего на Raspberry Pi. В такой ситуации можно указать в конфигурации mcu параметр "restart_method: rpi_usb" - этот параметр обеспечит сброс микроконтроллера через USB-питание, что позволит сбросить и микроконтроллер, и драйверы шагового двигателя вместе. При использовании этого механизма необходимо вручную настроить секции конфигурации "trigger_phase" (подробности см. в [config reference](Config_Reference.md#endstop_phase)).
